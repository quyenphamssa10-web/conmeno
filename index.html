<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mua B√°n T√°o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f8f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
        }
        
        .balance-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background-color: #fff;
        }
        
        .balance-item {
            background-color: #eaeaea;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .content {
            flex: 1;
            padding: 20px;
        }
        
        /* Trang Mua */
        .campaigns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .campaign {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .campaign:hover {
            transform: scale(1.03);
        }
        
        .campaign:active {
            transform: scale(0.97);
        }
        
        .campaign-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .campaign-apples {
            font-size: 24px;
            margin: 10px 0;
        }
        
        .reset-btn {
            width: 100%;
            padding: 16px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Trang B√°n */
        .create-box {
            margin: 60px auto;
            max-width: 90%;
            padding: 60px 20px;
            text-align: center;
            border: 3px dashed #ccc;
            border-radius: 16px;
            font-size: 20px;
            color: #666;
            background-color: #fff;
            cursor: pointer;
        }
        
        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background-color: #fff;
            border-top: 1px solid #ddd;
            height: 70px;
        }
        
        .nav-btn {
            flex: 1;
            font-size: 32px;
            background: none;
            border: none;
            padding: 10px;
        }
        
        .nav-btn.active {
            background-color: #e0f0ff;
            color: #007bff;
            font-weight: bold;
        }
        
        /* ·∫®n trang */
        .page {
            display: none;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #modal-title {
            font-size: 22px;
            margin-bottom: 15px;
        }

        #modal-message {
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }

        #apple-input {
            width: 80%;
            padding: 12px;
            font-size: 20px;
            border-radius: 12px;
            border: 1px solid #ccc;
            text-align: center;
            margin-bottom: 20px;
        }

        #feedback-message {
            font-size: 18px;
            margin: 20px 0;
            min-height: 60px;
        }

        #confirm-btn {
            background-color: #4CAF50;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        .no-campaigns {
            grid-column: 1 / -1;
            text-align: center;
            color: #888;
            font-size: 18px;
            padding: 40px;
        }
    </style>
</head>
<body>

    <!-- Modal chung -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <p id="modal-message"></p>
            <input type="number" id="apple-input" min="1" placeholder="Nh·∫≠p s·ªë t√°o">
            <div id="preview-group"></div>
            <p id="feedback-message"></p>
            <button id="confirm-btn">X√°c nh·∫≠n</button>
        </div>
    </div>

    <!-- Trang Mua (1) -->
    <div id="buy-page" class="page active">
        <div class="balance-container">
            <div class="balance-item">ü™ô <span id="user-coins">0</span></div>
            <div class="balance-item">üçé <span id="user-apples">0</span></div>
        </div>
        
        <div class="content">
            <div class="campaigns" id="campaigns-container">
                <!-- Chi·∫øn d·ªãch s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
            </div>
            
            <button class="reset-btn" id="reset-btn">Reset chi·∫øn d·ªãch</button>
        </div>
        
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchPage('buy')">üçé</button>
            <button class="nav-btn" onclick="switchPage('sell')">üí∞</button>
        </div>
    </div>

    <!-- Trang B√°n (2) -->
    <div id="sell-page" class="page">
        <div class="balance-container">
            <div class="balance-item">ü™ô <span id="user-coins-sell">0</span></div>
            <div class="balance-item">üçé <span id="user-apples-sell">0</span></div>
        </div>
        
        <div class="content">
            <div class="create-box" id="create-box">
                B·∫•m v√†o ƒë√¢y ƒë·ªÉ t·∫°o chi·∫øn d·ªãch
            </div>
        </div>
        
        <div class="bottom-nav">
            <button class="nav-btn" onclick="switchPage('buy')">üçé</button>
            <button class="nav-btn active" onclick="switchPage('sell')">üí∞</button>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu
        let user = { coins: 1234, apples: 567 };
        let campaigns = []; // Ch·ªâ ch·ª©a chi·∫øn d·ªãch c√≤n h√†ng (>0 t√°o)
        let currentCampaign = null; // Null = ch·∫ø ƒë·ªô b√°n, c√≥ gi√° tr·ªã = ch·∫ø ƒë·ªô mua
        const RATE_COIN_PER_APPLE = 10; // M·ªói t√°o b√°n nh·∫≠n 10 coin

        let previewApples, previewCoin; // S·∫Ω ƒë∆∞·ª£c g√°n l·∫°i sau m·ªói l·∫ßn m·ªü modal

        // Load d·ªØ li·ªáu t·ª´ localStorage
        window.onload = function() {
            const saved = localStorage.getItem('appleAppData');
            if (saved) {
                const data = JSON.parse(saved);
                user = data.user;
                campaigns = data.campaigns || [];
            }
            updateBalance();
            displayRandomCampaigns();
        };

        // L∆∞u d·ªØ li·ªáu
        function saveData() {
            // L√†m s·∫°ch chi·∫øn d·ªãch h·∫øt h√†ng
            campaigns = campaigns.filter(c => c.apples > 0);
            localStorage.setItem('appleAppData', JSON.stringify({ user, campaigns }));
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã coin v√† t√°o
        function updateBalance() {
            document.getElementById('user-coins').textContent = user.coins;
            document.getElementById('user-apples').textContent = user.apples;
            document.getElementById('user-coins-sell').textContent = user.coins;
            document.getElementById('user-apples-sell').textContent = user.apples;
        }

        // Hi·ªÉn th·ªã ng·∫´u nhi√™n 4 chi·∫øn d·ªãch c√≤n h√†ng
        function displayRandomCampaigns() {
            const available = campaigns.filter(c => c.apples > 0);
            let selected = [];
            if (available.length > 0) {
                let temp = [...available];
                for (let i = 0; i < 4 && temp.length > 0; i++) {
                    const idx = Math.floor(Math.random() * temp.length);
                    selected.push(temp.splice(idx, 1)[0]);
                }
            }

            const container = document.getElementById('campaigns-container');
            container.innerHTML = '';

            if (selected.length === 0) {
                container.innerHTML = '<div class="no-campaigns">Kh√¥ng c√≥ chi·∫øn d·ªãch n√†o ƒëang ƒë·ªÅ xu·∫•t.<br>H√£y sang trang b√°n ƒë·ªÉ t·∫°o m·ªõi!</div>';
                return;
            }

            selected.forEach(c => {
                const div = document.createElement('div');
                div.className = 'campaign';
                div.innerHTML = `
                    <div class="campaign-title">B√°n t√°o</div>
                    <div class="campaign-apples">${c.apples} üçé</div>
                    <div>Gi√°: ${c.price} ü™ô/qu·∫£</div>
                    <div style="color:green; margin-top:8px;">C√≤n h√†ng</div>
                `;
                div.onclick = () => openBuyModal(c);
                container.appendChild(div);
            });

            // Placeholder n·∫øu √≠t h∆°n 4
            for (let i = selected.length; i < 4; i++) {
                const div = document.createElement('div');
                div.className = 'campaign';
                div.style.opacity = '0.4';
                div.innerHTML = '<div>Kh√¥ng c√≥ chi·∫øn d·ªãch</div>';
                container.appendChild(div);
            }
        }

        // Modal functions
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const appleInput = document.getElementById('apple-input');
        const previewGroup = document.getElementById('preview-group');
        const feedbackMessage = document.getElementById('feedback-message');
        const confirmBtn = document.getElementById('confirm-btn');

        function closeModal() {
            modal.style.display = 'none';
            currentCampaign = null;
        }

        function openCreateModal() {
            currentCampaign = null;
            modalTitle.textContent = 'Nh·∫≠p s·ªë t√°o b·∫°n mu·ªën b√°n';
            modalMessage.textContent = 'B·∫°n s·∫Ω nh·∫≠n ngay coin t∆∞∆°ng ·ª©ng khi t·∫°o chi·∫øn d·ªãch.';
            appleInput.placeholder = 'Nh·∫≠p s·ªë t√°o b·∫°n mu·ªën b√°n';
            appleInput.value = '';
            appleInput.removeAttribute('max');

            previewGroup.innerHTML = `
                <div style="text-align:center; margin:15px 0; font-size:16px;">
                    T·ª∑ gi√° b√°n: ${RATE_COIN_PER_APPLE} ü™ô/qu·∫£
                </div>
                <div class="balance-item" style="justify-content:center; margin:10px auto;">
                    üçé - <span id="preview-apples">0</span>
                </div>
                <div class="balance-item" style="justify-content:center; margin:10px auto;">
                    ü™ô + <span id="preview-coin">0</span>
                </div>
            `;

            previewApples = document.getElementById('preview-apples');
            previewCoin = document.getElementById('preview-coin');

            // === RESET HI·ªÇN TH·ªä KHI M·ªû MODAL B√ÅN ===
            appleInput.style.display = 'block';
            previewGroup.style.display = 'block';
            feedbackMessage.style.display = 'none';

            modal.style.display = 'flex';
        }

        function openBuyModal(camp) {
            currentCampaign = camp;
            modalTitle.textContent = 'Th√¥ng b√°o';
            modalMessage.textContent = 'H√£y nh·∫≠p s·ªë t√°o b·∫°n mu·ªën mua';
            appleInput.placeholder = 'H√¥m nay b·∫°n mu·ªën mua bao nhi√™u t√°o?';
            appleInput.value = '';
            appleInput.max = camp.apples;

            previewGroup.innerHTML = `
                <div style="text-align:center; margin:15px 0; font-size:16px; color:#333;">
                    Gi√°: ${camp.price} ü™ô/qu·∫£<br>
                    C√≤n l·∫°i: ${camp.apples} üçé
                </div>
                <div class="balance-item" style="justify-content:center; margin:10px auto;">
                    üçé + <span id="preview-apples">0</span>
                </div>
                <div class="balance-item" style="justify-content:center; margin:10px auto;">
                    ü™ô - <span id="preview-coin">0</span>
                </div>
            `;

            previewApples = document.getElementById('preview-apples');
            previewCoin = document.getElementById('preview-coin');

            // === RESET HI·ªÇN TH·ªä KHI M·ªû MODAL MUA ===
            appleInput.style.display = 'block';
            previewGroup.style.display = 'block';
            feedbackMessage.style.display = 'none';

            modal.style.display = 'flex';
        }

        function openFeedback(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = '';
            appleInput.style.display = 'none';
            previewGroup.style.display = 'none';
            feedbackMessage.style.display = 'block';
            feedbackMessage.innerHTML = message;
            modal.style.display = 'flex';
        }

        // ƒê√≥ng modal khi b·∫•m ngo√†i
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Preview realtime khi nh·∫≠p
        appleInput.addEventListener('input', () => {
            let val = parseInt(appleInput.value) || 0;
            if (val < 0) val = 0;

            if (currentCampaign) { // Ch·∫ø ƒë·ªô mua
                if (val > currentCampaign.apples) {
                    val = currentCampaign.apples;
                    appleInput.value = val;
                }
                previewApples.textContent = val;
                previewCoin.textContent = val * currentCampaign.price;
            } else { // Ch·∫ø ƒë·ªô b√°n
                previewApples.textContent = val;
                previewCoin.textContent = val * RATE_COIN_PER_APPLE;
            }
        });

        // X·ª≠ l√Ω n√∫t x√°c nh·∫≠n
        confirmBtn.onclick = () => {
            const val = parseInt(appleInput.value) || 0;

            if (currentCampaign) { // ================== CH·∫æ ƒê·ªò MUA ==================
                if (val <= 0 || val > currentCampaign.apples) {
                    openFeedback('Th√¥ng b√°o', `Chi·∫øn d·ªãch ch·ªâ c√≤n ${currentCampaign.apples} üçé.<br>B·∫°n ch·ªâ c√≥ th·ªÉ mua t·ªëi ƒëa ${currentCampaign.apples} t√°o!`);
                    return;
                }

                const cost = val * currentCampaign.price;

                if (user.coins < cost) {
                    const thieu = cost - user.coins;
                    openFeedback('Ph·∫£n h·ªìi', `B·∫°n c√≤n thi·∫øu ${thieu} ü™ô n·ªØa ƒë·ªÉ mua ${val} üçé.<br>N·∫øu t√†i ch√≠nh kh√¥ng ·ªïn th√¨ h√£y mua v·ªõi m·ª©c gi√° h·ªùi h∆°n nh√°!`);
                    return;
                }

                // Th√†nh c√¥ng mua
                user.coins -= cost;
                user.apples += val;
                currentCampaign.apples -= val;

                saveData();
                updateBalance();
                displayRandomCampaigns();
                closeModal();

                openFeedback('Ph·∫£n h·ªìi', `B·∫°n ƒë√£ mua ƒë∆∞·ª£c ${val} üçé v·ªõi gi√° ${cost} ü™ô!`);

            } else { // ================== CH·∫æ ƒê·ªò B√ÅN ==================
                if (val <= 0) {
                    openFeedback('Th√¥ng b√°o', 'Vui l√≤ng nh·∫≠p s·ªë t√°o l·ªõn h∆°n 0!');
                    return;
                }

                if (user.apples < val) {
                    const thieu = val - user.apples;
                    openFeedback('Th√¥ng b√°o', `S·ªë t√°o c·ªßa b·∫°n hi·ªán t·∫°i c√≤n thi·∫øu ${thieu} üçé.<br>H√£y ki·∫øm th√™m t√°o ƒë·ªÉ b√°n nh√©!`);
                    return;
                }

                // Th√†nh c√¥ng b√°n
                user.apples -= val;
                const receivedCoin = val * RATE_COIN_PER_APPLE;
                user.coins += receivedCoin;

                const newPrice = Math.floor(Math.random() * 11) + 5; // 5-15 coin/qu·∫£
                const newCampaign = {
                    title: 'B√°n t√°o',
                    apples: val,
                    price: newPrice
                };
                campaigns.push(newCampaign);

                saveData();
                updateBalance();
                closeModal();

                openFeedback('Ph·∫£n h·ªìi', `B·∫°n ƒë√£ b√°n th√†nh c√¥ng ${val} üçé v√† nh·∫≠n ${receivedCoin} ü™ô!`);

                // N·∫øu ƒëang ·ªü trang mua th√¨ refresh chi·∫øn d·ªãch
                if (document.getElementById('buy-page').classList.contains('active')) {
                    displayRandomCampaigns();
                }
            }
        };

        // S·ª± ki·ªán b·∫•m t·∫°o chi·∫øn d·ªãch
        document.getElementById('create-box').onclick = openCreateModal;

        // S·ª± ki·ªán reset chi·∫øn d·ªãch
        document.getElementById('reset-btn').onclick = displayRandomCampaigns;

        // Chuy·ªÉn trang
        function switchPage(page) {
            document.getElementById('buy-page').classList.remove('active');
            document.getElementById('sell-page').classList.remove('active');
            
            if (page === 'buy') {
                document.getElementById('buy-page').classList.add('active');
                displayRandomCampaigns();
            } else {
                document.getElementById('sell-page').classList.add('active');
            }
        }
    </script>
</body>
</html>